<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EventSphere - My Registrations</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #00c3ff;
      --primary-light: rgba(0, 195, 255, 0.1);
      --secondary: #009ac1;
      --accent: #4cc9f0;
      --success: #4CAF50;
      --warning: #FFC107;
      --danger: #f44336;
      --dark: #121212;
      --light: #f8f9fa;
      --text-muted: #cccccc;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(rgba(0,0,0,0.85),rgba(0,0,0,0.85)), url('https://images.unsplash.com/photo-1531058020387-3be344556be6?auto=format&fit=crop&w=1950&q=80') no-repeat center center/cover;
      background-attachment: fixed;
      color: #fff;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      background: rgba(0,0,0,0.9);
      padding: 20px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .logo {
      font-size: 28px;
      font-weight: bold;
      color: var(--primary);
      text-decoration: none;
      display: flex; align-items: center;
    }
    .logo i { margin-right: 10px; }
    .nav-links { display: flex; gap: 20px; }
    .nav-links a {
      color: #fff; text-decoration: none; font-size: 16px; transition: color 0.3s; position: relative;
    }
    .nav-links a.active, .nav-links a:hover { color: var(--primary); }
    .nav-links a.active::after {
      content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 2px; background: var(--primary);
    }
    .back-button {
      color: #fff; text-decoration: none; font-size: 16px; display: flex; align-items: center;
      margin-bottom: 20px; padding: 8px 15px; background: var(--primary-light); border-radius: 20px; width: fit-content; transition: all 0.3s;
    }
    .back-button:hover { background: rgba(0,195,255,0.2); }
    .back-button i { margin-right: 8px; }
    .page-title {
      font-size: 36px; margin-bottom: 30px; color: var(--primary); text-align: center; position: relative; padding-bottom: 15px;
    }
    .page-title::after {
      content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 100px; height: 3px; background: var(--primary); border-radius: 3px;
    }
    .section-title {
      font-size: 24px; margin: 30px 0 20px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: flex; align-items: center;
    }
    .section-title i { margin-right: 10px; }
    .registrations-container {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; margin-bottom: 50px;
    }
    .registration-card {
      background: rgba(20,20,20,0.95);
      border-radius: 12px;
      margin-bottom: 25px;
      padding: 25px;
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }
    .registration-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
    .registration-card::before {
      content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary);
    }
    .event-image { width: 100%; height: 180px; object-fit: cover; }
    .registration-badge {
      position: absolute; top: 15px; right: 15px; padding: 5px 12px; border-radius: 20px;
      font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;
    }
    .badge-confirmed { background: var(--success); color: #fff; }
    .badge-upcoming { background: var(--primary); color: #fff; }
    .badge-cancelled { background: var(--danger); color: #fff; }
    .badge-pending { background: var(--warning); color: #000; }
    .registration-content { padding: 0; }
    .event-title {
      font-size: 22px; margin-bottom: 10px; color: var(--primary); display: flex; justify-content: space-between; align-items: center;
    }
    .event-date { font-size: 14px; color: var(--text-muted); margin-bottom: 15px; display: flex; align-items: center; }
    .event-date i { margin-right: 8px; color: var(--primary); }
    .registration-details {
      margin: 15px 0;
      padding: 15px 0;
      border-top: 1px solid var(--primary-light);
      border-bottom: 1px solid var(--primary-light);
    }
    .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .detail-label { color: var(--text-muted); font-size: 14px; }
    .detail-value { font-weight: 500; }
    .ticket-type {
      display: inline-block; padding: 3px 10px; border-radius: 15px; font-size: 12px; background: var(--primary-light); color: var(--primary);
    }
    .registration-actions { display: flex; gap: 10px; margin-top: 15px; }
    .btn {
      padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: all 0.3s;
      text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; flex: 1;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--secondary); transform: translateY(-2px);}
    .btn-outline { background: transparent; color: var(--primary); border: 1px solid var(--primary);}
    .btn-outline:hover { background: var(--primary-light);}
    .btn-danger { background: var(--danger); color: #fff;}
    .btn-danger:hover { background: #d32f2f;}
    .empty-state {
      text-align: center; padding: 50px 20px; grid-column: 1 / -1;
    }
    .empty-state i { font-size: 60px; color: var(--text-muted); margin-bottom: 20px; opacity: 0.5; }
    .empty-state h3 { color: var(--primary); margin-bottom: 15px; }
    .empty-state p { color: var(--text-muted); max-width: 500px; margin: 0 auto 20px; }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: rgba(0,0,0,0.8);
      border-radius: 10px;
      padding: 20px;
      border: 1px solid var(--primary-light);
      text-align: center;
      transition: all 0.3s;
    }
    .stat-value { font-size: 36px; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
    .stat-label { color: var(--text-muted); font-size: 14px; }
    .filter-container {
      display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;
    }
    .filter-btn {
      padding: 8px 16px; border-radius: 20px; background: var(--primary-light); color: #fff; border: none; cursor: pointer; transition: all 0.3s; font-size: 14px; display: flex; align-items: center; gap: 6px;
    }
    .filter-btn.active { background: var(--primary); color: #fff; }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
      background: rgba(20,20,20,0.95);
      border-radius: 15px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      border: 1px solid var(--primary-light);
      animation: modalFadeIn 0.3s ease-out;
    }
    .modal-icon { font-size: 60px; margin-bottom: 20px; }
    .success-icon { color: var(--success); }
    .modal-title { font-size: 24px; margin-bottom: 15px; color: var(--primary);}
    .modal-message { margin-bottom: 25px; color: var(--text-muted);}
    .modal-actions { display: flex; gap: 15px; justify-content: center; }
    @media (max-width: 768px) {
      .registrations-container { grid-template-columns: 1fr; }
      .page-title { font-size: 28px; }
      .section-title { font-size: 22px; }
      .stats-container { grid-template-columns: 1fr; }
      .registration-actions { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="home.html" class="logo">
        <i class="fas fa-calendar-alt"></i> EventSphere
      </a>
      <div class="nav-links">
        <a href="event.html">All Events</a>
        <a href="myregistration.html" class="active">My Registrations</a>
        <a href="profile.html">Profile</a>
      </div>
      <div id="user-rbac" style="margin-left:20px;"></div>
    </div>
  </header>
  <div class="container">
    <a href="home.html" class="back-button">
      <i class="fas fa-arrow-left"></i> Back to Home
    </a>
    <h1 class="page-title">My Registrations</h1>
    <!-- Registration Stats -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-value" id="totalRegistrations">0</div>
        <div class="stat-label">Total Registrations</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="upcomingEvents">0</div>
        <div class="stat-label">Upcoming Events</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalSpent">$0</div>
        <div class="stat-label">Total Spent</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="favoriteCategory">-</div>
        <div class="stat-label">Favorite Category</div>
      </div>
    </div>
    <!-- Filter Controls -->
    <div class="filter-container">
      <button class="filter-btn active" data-filter="all">
        <i class="fas fa-list"></i> All
      </button>
      <button class="filter-btn" data-filter="upcoming">
        <i class="fas fa-calendar-check"></i> Upcoming
      </button>
      <button class="filter-btn" data-filter="past">
        <i class="fas fa-history"></i> Past Events
      </button>
      <button class="filter-btn" data-filter="confirmed">
        <i class="fas fa-check-circle"></i> Confirmed
      </button>
      <button class="filter-btn" data-filter="cancelled">
        <i class="fas fa-times-circle"></i> Cancelled
      </button>
    </div>
    <!-- Registrations Grid -->
    <h2 class="section-title">
      <i class="fas fa-ticket-alt"></i> Your Event Registrations
    </h2>
    <div class="registrations-container" id="registrationsContainer">
      <div class="empty-state">
        <i class="fas fa-calendar-plus"></i>
        <h3>No Registrations Yet</h3>
        <p>You haven't registered for any events yet. Browse our upcoming events to get started!</p>
        <a href="event.html" class="btn btn-primary">
          <i class="fas fa-search"></i> Browse Events
        </a>
      </div>
    </div>
  </div>
  <!-- Confirmation Modal -->
  <div class="modal" id="confirmationModal">
    <div class="modal-content">
      <div class="modal-icon success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3 class="modal-title">Cancellation Confirmed</h3>
      <p class="modal-message">Your registration has been successfully cancelled. A refund will be processed within 5-7 business days.</p>
      <div class="modal-actions">
        <button class="btn btn-outline" id="modalCloseBtn">Close</button>
        <button class="btn btn-primary" id="modalContactBtn">Contact Support</button>
      </div>
    </div>
  </div>
  <footer>
    <div class="footer-content">
      <p>&copy; 2025 EventSphere. All rights reserved.</p>
    </div>
  </footer>
  <script>
    // DOM Elements
    const registrationsContainer = document.getElementById('registrationsContainer');
    const totalRegistrations = document.getElementById('totalRegistrations');
    const upcomingStats = document.getElementById('upcomingEvents');
    const totalSpent = document.getElementById('totalSpent');
    const favoriteCategory = document.getElementById('favoriteCategory');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const confirmationModal = document.getElementById('confirmationModal');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalContactBtn = document.getElementById('modalContactBtn');

    // Fetch registrations from backend
    async function fetchMyRegistrations() {
      const token = localStorage.getItem('token');
      if (!token) {
        registrationsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Please log in to view your registrations.</h3>
            <a href="login.html" class="btn btn-primary">
              <i class="fas fa-sign-in-alt"></i> Login
            </a>
          </div>`;
        return;
      }
      try {
        const response = await fetch('/my-registrations', {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        if (response.status === 401 || response.status === 403) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return;
        }
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const registrations = await response.json();
        renderRegistrations(registrations);
        updateStats(registrations);
      } catch (error) {
        registrationsContainer.innerHTML = '<p>Failed to load registrations.</p>';
      }
    }

    // Render registration cards
    function renderRegistrations(registrations) {
      if (!registrations || registrations.length === 0) {
        registrationsContainer.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-calendar-plus"></i>
            <h3>No Registrations Found</h3>
            <p>You don't have any registrations matching your current filter.</p>
            <a href="event.html" class="btn btn-primary">
              <i class="fas fa-search"></i> Browse Events
            </a>
          </div>
        `;
        return;
      }
      registrationsContainer.innerHTML = registrations.map(reg => {
        const status = (reg.status || 'confirmed').toLowerCase();
        const image = reg.image || 'https://images.unsplash.com/photo-1531058020387-3be344556be6?auto=format&fit=crop&w=600&q=80';
        const totalPrice = typeof reg.total_price === 'number' ? reg.total_price : 0;
        const purchaseDate = reg.purchase_date || reg.created_at || reg.event_date;
        return `
          <div class="registration-card" data-status="${status}" data-date="${reg.event_date}">
            <img src="${image}" alt="${reg.event_name}" class="event-image">
            <div class="registration-badge badge-${status}">
              ${status.charAt(0).toUpperCase() + status.slice(1)}
            </div>
            <div class="registration-content">
              <h3 class="event-title">
                ${reg.event_name}
                <span class="ticket-type">${getTicketTypeLabel(reg.ticket_type)}</span>
              </h3>
              <div class="event-date">
                <i class="far fa-calendar-alt"></i>
                ${formatDate(reg.event_date)}
              </div>
              <div class="registration-details">
                <div class="detail-row">
                  <span class="detail-label">Venue:</span>
                  <span class="detail-value">${reg.venue || '-'}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Tickets:</span>
                  <span class="detail-value">${reg.quantity || 1}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Total Paid:</span>
                  <span class="detail-value">$${totalPrice.toFixed(2)}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Booked On:</span>
                  <span class="detail-value">${formatDate(purchaseDate, true)}</span>
                </div>
              </div>
              <div class="registration-actions">
                ${(status === 'confirmed' || status === 'upcoming') ? `
                  <button class="btn btn-outline view-ticket-btn" data-reg-id="${reg.reg_id || reg.id}">
                    <i class="fas fa-ticket-alt"></i> View Ticket
                  </button>
                  <button class="btn btn-danger cancel-btn" 
                          data-reg-id="${reg.reg_id || reg.id}" 
                          data-reg-source="${reg.source || 'registrations'}">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                ` : `
                  <button class="btn btn-outline" disabled>
                    <i class="fas fa-ban"></i> Cancelled
                  </button>
                  <button class="btn btn-primary rebook-btn" data-event-id="${reg.event_id}">
                    <i class="fas fa-redo"></i> Rebook
                  </button>
                `}
              </div>
            </div>
          </div>
        `;
      }).join('');
      // Event listeners
      document.querySelectorAll('.view-ticket-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const regId = btn.dataset.regId;
          viewTicket(regId);
        });
      });
      document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const regId = btn.dataset.regId;
          const regSource = btn.dataset.regSource;
          console.log('Cancel regId:', regId, 'source:', regSource); // Debug log
          if (!regSource) {
            alert('Unable to cancel: registration source missing.');
            return;
          }
          if (!confirm('Are you sure you want to cancel this registration?')) return;
          const token = localStorage.getItem('token');
          try {
            const res = await fetch(`http://localhost:3000/cancel-registration/${regId}`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ source: regSource })
            });
            if (res.ok) {
              confirmationModal.style.display = 'flex';
              await fetchMyRegistrations();
            } else {
              alert('Failed to cancel registration.');
            }
          } catch (err) {
            alert('Error cancelling registration.');
          }
        });
      });
      document.querySelectorAll('.rebook-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const eventId = btn.dataset.eventId;
          rebookEvent(eventId);
        });
      });
    }
    // Stats
    function updateStats(registrations) {
      const now = new Date();
      totalRegistrations.textContent = registrations.length;
      const upcoming = registrations.filter(reg => {
        const eventDate = new Date(reg.event_date);
        return (reg.status === 'confirmed' || reg.status === 'upcoming') && eventDate > now;
      }).length;
      upcomingStats.textContent = upcoming;
      const spent = registrations.reduce((sum, reg) => {
        return reg.status === 'cancelled' ? sum : sum + reg.total_price;
      }, 0);
      totalSpent.textContent = '$' + spent.toFixed(2);
      const categoryCount = {};
      registrations.forEach(reg => {
        if (
          reg.status !== 'cancelled' &&
          reg.category &&
          typeof reg.category === 'string' &&
          reg.category.trim() !== ''
        ) {
          categoryCount[reg.category] = (categoryCount[reg.category] || 0) + 1;
        }
      });
      let favorite = '-';
      let maxCount = 0;
      for (const [cat, count] of Object.entries(categoryCount)) {
        if (count > maxCount) {
          favorite = cat;
          maxCount = count;
        }
      }
      favoriteCategory.textContent = favorite;
    }
    function getTicketTypeLabel(type) {
      const labels = {
        'standard': 'Standard',
        'vip': 'VIP',
        'premium': 'Premium',
        'student': 'Student',
        'free': 'Free Admission'
      };
      return labels[type] || (type ? type.charAt(0).toUpperCase() + type.slice(1) : '-');
    }
    function formatDate(dateString, includeTime = false) {
      const options = { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        ...(includeTime && { hour: '2-digit', minute: '2-digit' })
      };
      return new Date(dateString).toLocaleString('en-US', options);
    }
    function viewTicket(registrationId) {
      alert(`Viewing ticket for registration ${registrationId}`);
    }
    function rebookEvent(eventId) {
      alert(`Redirecting to event ${eventId} for rebooking...`);
    }
    // Filters
    function filterRegistrations(filter) {
      const cards = document.querySelectorAll('.registration-card');
      const now = new Date();
      let anyVisible = false;
      cards.forEach(card => {
        const status = card.dataset.status;
        const eventDate = new Date(card.dataset.date);
        let show = true;
        switch(filter) {
          case 'upcoming':
            show = (status === 'confirmed' || status === 'upcoming') && eventDate > now;
            break;
          case 'past':
            show = eventDate < now;
            break;
          case 'confirmed':
            show = status === 'confirmed';
            break;
          case 'cancelled':
            show = status === 'cancelled';
            break;
          case 'all':
          default:
            show = true; // Always show for "all"
            break;
        }
        card.style.display = show ? 'block' : 'none';
        if (show) anyVisible = true;
      });
      // Only show empty state if there are NO cards at all
      if (!anyVisible && cards.length > 0) {
        // Hide all cards, but keep the container
        cards.forEach(card => card.style.display = 'none');
        // Optionally, show a message (or leave as is)
      }
    }
    // Modal events
    modalCloseBtn.addEventListener('click', () => {
      confirmationModal.style.display = 'none';
    });
    modalContactBtn.addEventListener('click', () => {
      alert('Redirecting to support...');
      confirmationModal.style.display = 'none';
    });
    // Filter button handlers
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        filterRegistrations(button.dataset.filter);
      });
    });
    // RBAC & init
    document.addEventListener('DOMContentLoaded', () => {
      const userName = localStorage.getItem('user_name');
      const userType = localStorage.getItem('user_type');
      const userRBAC = document.getElementById('user-rbac');
      if (userRBAC) {
        if (userName) {
          userRBAC.innerHTML = `<span style="color:var(--primary);font-weight:bold;">Welcome, ${userName}</span>
            <span style="color:var(--text-muted);font-size:13px;margin-left:8px;">(${userType || 'user'})</span>
            <button id="logoutBtn" style="margin-left:15px;padding:4px 12px;border-radius:6px;border:none;background:var(--danger);color:#fff;cursor:pointer;">Logout</button>`;
        } else {
          userRBAC.innerHTML = `<a href="login.html" class="btn btn-primary" style="padding:6px 18px;">Login</a>`;
        }
      }
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.onclick = () => {
          localStorage.removeItem('token');
          localStorage.removeItem('user_type');
          localStorage.removeItem('user_name');
          window.location.href = 'login.html';
        };
      }
      if (!userType || (userType !== 'user' && userType !== 'admin' && userType !== 'attendee')) {
        alert('You do not have permission to access this page.');
        window.location.href = 'home.html';
      }
      fetchMyRegistrations();
    });
  </script>
</body>
</html>